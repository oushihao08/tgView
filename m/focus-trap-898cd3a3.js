import{ad as e,b as t,l as n,r as o,k as s,p as r,w as a,u,n as c,Y as d,O as f}from"./vue-10f3042e.js";import{_ as i}from"./index-8763a24f.js";import{E as l}from"./aria-b0977c34.js";import{c as p}from"./index-dea076ad.js";import{i as v}from"./lodash-es-87d81e2d.js";const m=(...t)=>n=>{t.forEach((t=>{e(t)?t(n):t.value=n}))};let E=[];const w=e=>{const t=e;t.key===l.esc&&E.forEach((e=>e(t)))},y={cancelable:!0,bubbles:!1},h={cancelable:!0,bubbles:!1},L=Symbol("elFocusTrap"),T=o(),b=o(0),k=o(0);let R=0;const g=e=>{const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const t="INPUT"===e.tagName&&"hidden"===e.type;return e.disabled||e.hidden||t?NodeFilter.FILTER_SKIP:e.tabIndex>=0||e===document.activeElement?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;n.nextNode();)t.push(n.currentNode);return t},F=(e,t)=>{for(const n of e)if(!K(n,t))return n},K=(e,t)=>{if("hidden"===getComputedStyle(e).visibility)return!0;for(;e;){if(t&&e===t)return!1;if("none"===getComputedStyle(e).display)return!0;e=e.parentElement}return!1},N=(e,t)=>{if(e&&e.focus){const n=document.activeElement;e.focus({preventScroll:!0}),k.value=window.performance.now(),e!==n&&(e=>e instanceof HTMLInputElement&&"select"in e)(e)&&t&&e.select()}};function P(e,t){const n=[...e],o=e.indexOf(t);return-1!==o&&n.splice(o,1),n}const S=(()=>{let e=[];return{push:t=>{const n=e[0];n&&t!==n&&n.pause(),e=P(e,t),e.unshift(t)},remove:t=>{var n,o;e=P(e,t),null==(o=null==(n=e[0])?void 0:n.resume)||o.call(n)}}})(),I=()=>{T.value="pointer",b.value=window.performance.now()},j=()=>{T.value="keyboard",b.value=window.performance.now()},A=e=>new CustomEvent("focus-trap.focusout-prevented",{...h,detail:e});var _=i(s({name:"ElFocusTrap",inheritAttrs:!1,props:{loop:Boolean,trapped:Boolean,focusTrapEl:Object,focusStartEl:{type:[Object,String],default:"first"}},emits:["focusAfterTrapped","focusAfterReleased","focusin","focusout","focusout-prevented","release-requested"],setup(e,{emit:s}){const f=o();let i,m;const{focusReason:h}=(t((()=>{0===R&&(document.addEventListener("mousedown",I),document.addEventListener("touchstart",I),document.addEventListener("keydown",j)),R++})),n((()=>{R--,R<=0&&(document.removeEventListener("mousedown",I),document.removeEventListener("touchstart",I),document.removeEventListener("keydown",j))})),{focusReason:T,lastUserFocusTimestamp:b,lastAutomatedFocusTimestamp:k});var K;K=t=>{e.trapped&&!P.paused&&s("release-requested",t)},t((()=>{0===E.length&&document.addEventListener("keydown",w),p&&E.push(K)})),n((()=>{E=E.filter((e=>e!==K)),0===E.length&&p&&document.removeEventListener("keydown",w)}));const P={paused:!1,pause(){this.paused=!0},resume(){this.paused=!1}},_=t=>{if(!e.loop&&!e.trapped)return;if(P.paused)return;const{key:n,altKey:o,ctrlKey:r,metaKey:a,currentTarget:u,shiftKey:c}=t,{loop:d}=e,f=n===l.tab&&!o&&!r&&!a,i=document.activeElement;if(f&&i){const e=u,[n,o]=(e=>{const t=g(e);return[F(t,e),F(t.reverse(),e)]})(e);if(n&&o)if(c||i!==o){if(c&&[n,e].includes(i)){const e=A({focusReason:h.value});s("focusout-prevented",e),e.defaultPrevented||(t.preventDefault(),d&&N(o,!0))}}else{const e=A({focusReason:h.value});s("focusout-prevented",e),e.defaultPrevented||(t.preventDefault(),d&&N(n,!0))}else if(i===e){const e=A({focusReason:h.value});s("focusout-prevented",e),e.defaultPrevented||t.preventDefault()}}};r(L,{focusTrapRef:f,onKeydown:_}),a((()=>e.focusTrapEl),(e=>{e&&(f.value=e)}),{immediate:!0}),a([f],(([e],[t])=>{e&&(e.addEventListener("keydown",_),e.addEventListener("focusin",O),e.addEventListener("focusout",D)),t&&(t.removeEventListener("keydown",_),t.removeEventListener("focusin",O),t.removeEventListener("focusout",D))}));const x=e=>{s("focusAfterTrapped",e)},C=e=>s("focusAfterReleased",e),O=t=>{const n=u(f);if(!n)return;const o=t.target,r=t.relatedTarget,a=o&&n.contains(o);if(!e.trapped){r&&n.contains(r)||(i=r)}a&&s("focusin",t),P.paused||e.trapped&&(a?m=o:N(m,!0))},D=t=>{const n=u(f);if(!P.paused&&n)if(e.trapped){const o=t.relatedTarget;v(o)||n.contains(o)||setTimeout((()=>{if(!P.paused&&e.trapped){const e=A({focusReason:h.value});s("focusout-prevented",e),e.defaultPrevented||N(m,!0)}}),0)}else{const e=t.target;e&&n.contains(e)||s("focusout",t)}};async function q(){await c();const t=u(f);if(t){S.push(P);const n=t.contains(document.activeElement)?i:document.activeElement;i=n;if(!t.contains(n)){const o=new Event("focus-trap.focus-after-trapped",y);t.addEventListener("focus-trap.focus-after-trapped",x),t.dispatchEvent(o),o.defaultPrevented||c((()=>{let o=e.focusStartEl;d(o)||(N(o),document.activeElement!==o&&(o="first")),"first"===o&&((e,t=!1)=>{const n=document.activeElement;for(const o of e)if(N(o,t),document.activeElement!==n)return})(g(t),!0),document.activeElement!==n&&"container"!==o||N(t)}))}}}function B(){const e=u(f);if(e){e.removeEventListener("focus-trap.focus-after-trapped",x);const t=new CustomEvent("focus-trap.focus-after-released",{...y,detail:{focusReason:h.value}});e.addEventListener("focus-trap.focus-after-released",C),e.dispatchEvent(t),t.defaultPrevented||"keyboard"!=h.value&&b.value>k.value||N(null!=i?i:document.body),e.removeEventListener("focus-trap.focus-after-released",x),S.remove(P)}}return t((()=>{e.trapped&&q(),a((()=>e.trapped),(e=>{e?q():B()}))})),n((()=>{e.trapped&&B()})),{onKeydown:_}}}),[["render",function(e,t,n,o,s,r){return f(e.$slots,"default",{handleKeydown:e.onKeydown})}],["__file","/home/runner/work/element-plus/element-plus/packages/components/focus-trap/src/focus-trap.vue"]]);export{_ as E,L as F,m as c};
//# sourceMappingURL=focus-trap-898cd3a3.js.map
